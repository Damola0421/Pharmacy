<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PharmaSafe Mobile</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Mobile Validations */
        .container { max-width: 800px; } /* Keep it neat on tablets */
        
        /* Status Indicators */
        .risk-expired { border-left: 5px solid #dc3545; background-color: #fff5f5; }
        .risk-warning { border-left: 5px solid #ffc107; background-color: #fffdf5; }
        .risk-safe { border-left: 5px solid #198754; }

        /* Mobile Card Styling */
        .card-stat { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Prevent table text from wrapping awkwardly on mobile */
        .table-nowrap th, .table-nowrap td {
            white-space: nowrap;
        }

        /* Fixed Height History */
        .history-container {
            max-height: 350px;
            overflow-y: auto;
        }

        /* Floating Action Button (FAB) style for mobile 'Add' */
        .btn-add-mobile {
            display: none; /* Hidden on desktop */
        }
        
        @media (max-width: 768px) {
            .btn-add-desktop { display: none; }
            .btn-add-mobile {
                display: block;
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                font-size: 24px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                z-index: 1000;
            }
            h4 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-heart-pulse-fill"></i> PharmaSafe
            </a>
            <span class="navbar-text text-white small">
                <i class="bi bi-person-circle"></i> Admin
            </span>
        </div>
    </nav>

    <div class="container mt-3 pb-5">
        
        <div class="row g-2 mb-4">
            <div class="col-6 col-md-4">
                <div class="card card-stat border-start border-4 border-primary h-100">
                    <div class="card-body p-3">
                        <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Inventory</small>
                        <h3 class="fw-bold text-primary mb-0" id="statTotal">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card card-stat border-start border-4 border-danger h-100">
                    <div class="card-body p-3">
                        <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Expired</small>
                        <h3 class="fw-bold text-danger mb-0" id="statExpired">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card card-stat border-start border-4 border-success h-100">
                    <div class="card-body p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Total Sales</small>
                            <h3 class="fw-bold text-success mb-0" id="statSales">0</h3>
                        </div>
                        <i class="bi bi-receipt fs-1 text-success opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-secondary mb-0">Current Stock</h5>
            <button class="btn btn-sm btn-primary btn-add-desktop" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="bi bi-plus-lg"></i> Add Batch
            </button>
        </div>

        <div class="card shadow-sm border-0 mb-4 overflow-hidden rounded-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 table-nowrap">
                    <thead class="table-light text-secondary small">
                        <tr>
                            <th>Drug Name</th>
                            <th>Expiry</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        </tbody>
                </table>
            </div>
            <div id="emptyState" class="text-center p-5 text-muted bg-white" style="display:none;">
                <i class="bi bi-box-seam fs-1"></i>
                <p class="small mt-2">No inventory found.</p>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-secondary mb-0">Sales History</h5>
            </div>

        <div class="card shadow-sm border-0 rounded-3">
            <div class="card-body p-0 history-container">
                <div class="table-responsive">
                    <table class="table table-striped mb-0 table-nowrap small">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Item</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            </tbody>
                    </table>
                </div>
                <div id="emptyHistory" class="text-center p-4 text-muted small" style="display:none;">
                    No transactions yet.
                </div>
            </div>
        </div>

    </div>

    <button class="btn btn-primary btn-add-mobile" data-bs-toggle="modal" data-bs-target="#addModal">
        <i class="bi bi-plus-lg"></i>
    </button>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">New Batch</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="addForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label text-muted small">Drug Name</label>
                            <input type="text" id="addName" class="form-control" required placeholder="e.g. Paracetamol">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Batch ID</label>
                            <input type="text" id="addBatch" class="form-control" required placeholder="e.g. B-001">
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label text-muted small">Expiry</label>
                                <input type="date" id="addDate" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label text-muted small">Qty</label>
                                <input type="number" id="addQty" class="form-control" required min="1">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary px-4">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dispenseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm"> 
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Dispense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="dispenseForm">
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <h6 class="fw-bold mb-0" id="dispenseNameDisplay">Name</h6>
                            <small class="text-muted">Stock: <span id="dispenseStockDisplay">0</span></small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold">Customer Name</label>
                            <input type="text" id="dispenseCustomer" class="form-control" placeholder="Required" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Quantity</label>
                            <input type="number" id="dispenseQtyInput" class="form-control form-control-lg text-center fw-bold" required min="1">
                        </div>
                        <div class="alert alert-danger py-1 small text-center" id="dispenseError" style="display:none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success w-100 py-2">Confirm Sale</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. DATA INITIALIZATION ---
        let inventory = JSON.parse(localStorage.getItem('pharmaInventory')) || [];
        let logs = JSON.parse(localStorage.getItem('pharmaLogs')) || [];
        let selectedIndex = null; 

        const addModal = new bootstrap.Modal(document.getElementById('addModal'));
        const dispenseModal = new bootstrap.Modal(document.getElementById('dispenseModal'));

        // --- 2. RENDER FUNCTIONS ---
        function renderAll() {
            renderInventory();
            renderHistory();
            updateStats();
        }

        function renderInventory() {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = "";
            
            if (inventory.length === 0) document.getElementById('emptyState').style.display = 'block';
            else document.getElementById('emptyState').style.display = 'none';

            inventory.forEach((item, index) => {
                const today = new Date();
                const diff = new Date(item.expiry) - today;
                const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
                
                let rowClass = 'risk-safe';
                let statusBadge = '<i class="bi bi-check-circle-fill text-success"></i>';
                let isExpired = false;

                if (daysLeft < 0) {
                    rowClass = 'risk-expired';
                    statusBadge = '<span class="badge bg-danger">EXP</span>';
                    isExpired = true;
                } else if (daysLeft < 30) {
                    rowClass = 'risk-warning';
                    statusBadge = '<span class="badge bg-warning text-dark">WARN</span>';
                }

                const isOutOfStock = item.qty <= 0;
                const stockDisplay = isOutOfStock 
                    ? '<span class="text-danger fw-bold">0</span>' 
                    : `<span class="fw-bold">${item.qty}</span>`;
                
                // Button Logic
                const btnDisabled = (isExpired || isOutOfStock) ? 'disabled' : '';
                const btnClass = (isExpired || isOutOfStock) ? 'btn-outline-secondary' : 'btn-outline-success';

                const row = `
                    <tr class="${rowClass}">
                        <td class="fw-bold">${item.name}<br><small class="text-muted fw-normal">${item.batch}</small></td>
                        <td><small>${item.expiry}</small></td>
                        <td>${stockDisplay}</td>
                        <td>${statusBadge}</td>
                        <td class="text-end">
                            <button class="btn btn-sm ${btnClass}" 
                                onclick="openDispenseModal(${index})" ${btnDisabled}>
                                <i class="bi bi-cart-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" 
                                onclick="deleteItem(${index})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = "";
            
            if (logs.length === 0) document.getElementById('emptyHistory').style.display = 'block';
            else document.getElementById('emptyHistory').style.display = 'none';

            logs.forEach(log => {
                const row = `
                    <tr>
                        <td class="text-muted">${log.date}</td>
                        <td class="fw-bold text-dark">${log.customer}</td>
                        <td>${log.drugName} <span class="badge bg-light text-dark border">${log.batch}</span></td>
                        <td>${log.qtySold}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateStats() {
            let expired = 0;
            const today = new Date();
            inventory.forEach(i => {
                if (new Date(i.expiry) < today) expired++;
            });
            document.getElementById('statTotal').innerText = inventory.length;
            document.getElementById('statExpired').innerText = expired;
            document.getElementById('statSales').innerText = logs.length;
        }

        // --- 3. ACTIONS ---

        // Add Inventory
        document.getElementById('addForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newItem = {
                name: document.getElementById('addName').value,
                batch: document.getElementById('addBatch').value,
                expiry: document.getElementById('addDate').value,
                qty: parseInt(document.getElementById('addQty').value)
            };
            inventory.push(newItem);
            saveData();
            e.target.reset();
            addModal.hide();
        });

        // Open Dispense Modal
        window.openDispenseModal = function(index) {
            selectedIndex = index;
            const item = inventory[index];
            document.getElementById('dispenseNameDisplay').innerText = item.name;
            document.getElementById('dispenseStockDisplay').innerText = item.qty;
            document.getElementById('dispenseQtyInput').max = item.qty;
            document.getElementById('dispenseQtyInput').value = 1;
            document.getElementById('dispenseCustomer').value = ""; 
            document.getElementById('dispenseError').style.display = 'none';
            dispenseModal.show();
        };

        // Confirm Dispense
        document.getElementById('dispenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const qty = parseInt(document.getElementById('dispenseQtyInput').value);
            const customer = document.getElementById('dispenseCustomer').value;
            const stock = inventory[selectedIndex].qty;

            if (qty > stock) {
                const err = document.getElementById('dispenseError');
                err.innerText = "Insufficient Stock!";
                err.style.display = 'block';
                return;
            }

            // Update Inventory
            inventory[selectedIndex].qty -= qty;

            // Create Log (Short date for mobile)
            const d = new Date();
            const shortDate = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;

            const newLog = {
                date: shortDate,
                customer: customer,
                drugName: inventory[selectedIndex].name,
                batch: inventory[selectedIndex].batch,
                qtySold: qty
            };

            logs.unshift(newLog);

            // Save
            localStorage.setItem('pharmaInventory', JSON.stringify(inventory));
            localStorage.setItem('pharmaLogs', JSON.stringify(logs));
            
            renderAll();
            dispenseModal.hide();
        });

        // Delete Item
        window.deleteItem = function(index) {
            if(confirm("Delete this batch?")) {
                inventory.splice(index, 1);
                saveData();
            }
        };

        // Helper
        function saveData() {
            localStorage.setItem('pharmaInventory', JSON.stringify(inventory));
            renderAll();
        }

        // Init
        renderAll();
    </script>
</body>
</html>
